/* ==================== MALWARE SANDBOX SIMULATION ðŸ§ª ==================== */
/* Advanced static and behavioral analysis for threat hunting */

window.MalwareSandbox = {
    state: {
        currentFile: null,
        isAnalyzing: false,
        analysisResults: null,
        logs: []
    },

    init() {
        this.state = {
            currentFile: null,
            isAnalyzing: false,
            analysisResults: null,
            logs: []
        };
    },

    render() {
        return `
        <div class="sandbox-app fade-in">
            <div class="sandbox-header">
                <div class="header-info">
                    <h1><i class="fas fa-microscope"></i> Advanced Threat Sandbox</h1>
                    <p>Automated Static & Behavioral Malware Analysis</p>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" onclick="MalwareSandbox.triggerFileUpload()"><i class="fas fa-upload"></i> Upload Suspect File</button>
                    <input type="file" id="sandbox-upload" style="display:none" onchange="MalwareSandbox.handleFile(this)">
                </div>
            </div>

            <div class="sandbox-main">
                <div class="sidebar-logs">
                    <h3><i class="fas fa-stream"></i> Analysis Pipeline</h3>
                    <div class="pipeline-logs" id="sandbox-pipeline-logs">
                        ${this.state.logs.length === 0 ? '<div class="empty-log">System idle. Waiting for artifact...</div>' : this.state.logs.map(log => `<div class="log-entry"><span class="log-time">${log.time}</span> ${log.msg}</div>`).join('')}
                    </div>
                </div>

                <div class="analysis-viewport" id="sandbox-viewport">
                    ${this.renderViewport()}
                </div>
            </div>
        </div>
        ${this.getStyles()}`;
    },

    renderViewport() {
        if (!this.state.currentFile && !this.state.isAnalyzing) {
            return `
                <div class="empty-state">
                    <i class="fas fa-file-medical-alt"></i>
                    <h3>No file under analysis</h3>
                    <p>Upload a .exe, .dll, or .bin file to begin deep inspection.</p>
                </div>
            `;
        }

        if (this.state.isAnalyzing) {
            return `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <h3>Analyzing Artifact: ${this.state.currentFile.name}</h3>
                    <p id="analysis-step">Extracting PE headers...</p>
                </div>
            `;
        }

        const res = this.state.analysisResults;
        return `
            <div class="results-view fade-in">
                <div class="results-header">
                    <div class="res-title">
                        <h2>${res.fileName} <span class="res-hash">${res.sha256}</span></h2>
                        <div class="res-verdict ${res.verdict.toLowerCase()}">Verdict: ${res.verdict}</div>
                    </div>
                    <div class="res-score-box">
                        <div class="score-val" style="color: ${this.getScoreColor(res.score)}">${res.score}/100</div>
                        <div class="score-label">Threat Score</div>
                    </div>
                </div>

                <div class="results-grid">
                    <div class="grid-box static">
                        <h3><i class="fas fa-code"></i> Static Analysis</h3>
                        <div class="data-group">
                            <label>Entropy:</label> <span>${res.entropy} (HighPacker detected)</span>
                        </div>
                        <div class="data-group">
                            <label>Found Strings:</label>
                            <div class="strings-list">
                                ${res.strings.map(s => `<code>${s}</code>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="grid-box behavioral">
                        <h3><i class="fas fa-running"></i> Behavioral Triggers</h3>
                        <div class="trigger-list">
                            ${res.triggers.map(t => `
                                <div class="trigger-item ${t.risk}">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div class="t-info">
                                        <div class="t-name">${t.name}</div>
                                        <div class="t-desc">${t.desc}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    triggerFileUpload() {
        document.getElementById('sandbox-upload').click();
    },

    handleFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            this.state.currentFile = file;
            this.state.isAnalyzing = true;
            this.state.logs = [];
            this.addLog("Artifact uploaded: " + file.name);
            this.renderAll();

            this.runSimulation();
        }
    },

    addLog(msg) {
        const time = new Date().toLocaleTimeString([], { hour12: false });
        this.state.logs.push({ time, msg });
        const container = document.getElementById('sandbox-pipeline-logs');
        if (container) {
            container.innerHTML = this.state.logs.map(log => `<div class="log-entry"><span class="log-time">${log.time}</span> ${log.msg}</div>`).join('');
            container.scrollTop = container.scrollHeight;
        }
    },

    runSimulation() {
        const steps = [
            "Calculating SHA-256 hashes...",
            "Loading artifact into debugger...",
            "Scanning for packed sections...",
            "Extracting suspicious strings...",
            "Emulating API calls in secure memory...",
            "Finalizing threat verdict..."
        ];

        let stepIdx = 0;
        const interval = setInterval(() => {
            if (stepIdx >= steps.length) {
                clearInterval(interval);
                this.finalizeAnalysis();
                return;
            }
            this.addLog(steps[stepIdx]);
            const stepEl = document.getElementById('analysis-step');
            if (stepEl) stepEl.innerText = steps[stepIdx];
            stepIdx++;
        }, 1000);
    },

    finalizeAnalysis() {
        const isMalicious = Math.random() > 0.3;
        this.state.isAnalyzing = false;
        this.state.analysisResults = {
            fileName: this.state.currentFile.name,
            sha256: "ea33c18b...9f82c",
            verdict: isMalicious ? "MALICIOUS" : "CLEAN",
            score: isMalicious ? Math.floor(Math.random() * 30) + 70 : Math.floor(Math.random() * 20) + 5,
            entropy: isMalicious ? "7.82" : "4.31",
            strings: isMalicious ? ["http://c2.evil.com/gate", "RegOpenKeyA", "WriteProcessMemory", "SeDebugPrivilege"] : ["libc.so.6", "/usr/bin/local", "Hello World"],
            triggers: isMalicious ? [
                { name: "Code Injection", desc: "Detected attempt to use WriteProcessMemory on remote process.", risk: "high" },
                { name: "Persistent Backdoor", desc: "Creates registry key in HKLM\\Run to survive reboot.", risk: "high" },
                { name: "Network C2", desc: "Encoded URL found in data section pointing to known C2 TLD.", risk: "med" }
            ] : [
                { name: "Standard IO", desc: "Uses typical system libraries for output.", risk: "low" }
            ]
        };
        this.addLog("Analysis Complete. Verdict: " + this.state.analysisResults.verdict);
        this.renderAll();
    },

    getScoreColor(score) {
        if (score > 70) return "#ef4444";
        if (score > 40) return "#fbbf24";
        return "#22c55e";
    },

    renderAll() {
        const main = document.getElementById('content');
        if (main) main.innerHTML = this.render();
    },

    getStyles() {
        return `
        <style>
            .sandbox-app { display: flex; flex-direction: column; height: calc(100vh - 60px); color: #e0e0e0; font-family: 'Inter', sans-serif; background: #0f111a; }
            .sandbox-header { padding: 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2d3a; background: #161925; }
            .header-info h1 { margin: 0; font-size: 1.8rem; color: #fff; display: flex; align-items: center; gap: 15px; }
            .header-info p { margin: 5px 0 0; color: #6366f1; }
            
            .btn-primary { background: #6366f1; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
            .btn-primary:hover { background: #4f46e5; transform: translateY(-2px); }

            .sandbox-main { flex: 1; display: grid; grid-template-columns: 350px 1fr; overflow: hidden; }
            
            .sidebar-logs { background: #161925; border-right: 1px solid #2d2d3a; padding: 20px; display: flex; flex-direction: column; }
            .sidebar-logs h3 { font-size: 0.9rem; text-transform: uppercase; color: #555; margin-bottom: 20px; }
            .pipeline-logs { flex: 1; background: #0b0c14; border-radius: 12px; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; overflow-y: auto; border: 1px solid #1c1c26; }
            .log-entry { margin-bottom: 10px; line-height: 1.4; }
            .log-time { color: #6366f1; margin-right: 8px; }
            .empty-log { color: #333; text-align: center; margin-top: 50px; }

            .analysis-viewport { flex: 1; padding: 40px; overflow-y: auto; display: flex; justify-content: center; }
            .empty-state { text-align: center; color: #444; max-width: 400px; margin-top: 100px; }
            .empty-state i { font-size: 5rem; margin-bottom: 25px; color: #1c1c26; }
            
            .loading-state { text-align: center; margin-top: 100px; }
            .spinner { width: 50px; height: 50px; border: 5px solid #1c1c26; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 25px; }
            @keyframes spin { to { transform: rotate(360deg); } }

            .results-view { width: 100%; max-width: 1000px; }
            .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
            .res-title h2 { margin: 0; color: #fff; font-size: 1.8rem; }
            .res-hash { font-family: monospace; font-size: 0.8rem; color: #555; margin-left: 15px; }
            .res-verdict { margin-top: 10px; font-weight: 800; font-size: 1rem; }
            .res-verdict.malicious { color: #ef4444; }
            .res-verdict.clean { color: #22c55e; }

            .res-score-box { text-align: center; background: #161925; padding: 15px 30px; border-radius: 16px; border: 1px solid #2d2d3a; }
            .score-val { font-size: 2.2rem; font-weight: 900; }
            .score-label { font-size: 0.75rem; color: #555; text-transform: uppercase; margin-top: 5px; }

            .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
            .grid-box { background: #161925; padding: 25px; border-radius: 16px; border: 1px solid #2d2d3a; }
            .grid-box h3 { margin: 0 0 20px; font-size: 1.1rem; color: #fff; display: flex; align-items: center; gap: 12px; }
            
            .data-group { margin-bottom: 20px; }
            .data-group label { display: block; color: #555; font-size: 0.8rem; margin-bottom: 5px; }
            .strings-list { background: #0b0c14; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; }
            .strings-list code { display: block; color: #4ade80; margin-bottom: 5px; }

            .trigger-item { display: flex; gap: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #333; }
            .trigger-item.high { border-left-color: #ef4444; }
            .trigger-item.med { border-left-color: #fbbf24; }
            .trigger-item.low { border-left-color: #22c55e; }
            .trigger-item i { margin-top: 3px; }
            .t-name { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; color: #fff; }
            .t-desc { font-size: 0.85rem; color: #888; line-height: 1.4; }
        </style>`;
    }
};

function pageMalwareSandbox() {
    MalwareSandbox.init();
    return MalwareSandbox.render();
}
