import React, { useState, useEffect, useRef } from 'react';
import {
    Microscope, Shield, Activity, Upload, Terminal,
    FileCode, Server, Zap, AlertTriangle, CheckCircle,
    Search, Cpu, Database, Eye, Ghost, Skull, Play, Square, ExternalLink
} from 'lucide-react';
import { useLabManager } from '../../hooks/useLabManager';
import { motion, AnimatePresence } from 'framer-motion';

const MalwareSandbox = () => {
    // --- REAL LAB MANAGER ---
    const { status: labStatus, startLab, stopLab, connectionInfo, isLoading } = useLabManager('remnux-lab');
    // ------------------------
    const [file, setFile] = useState(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [logs, setLogs] = useState([]);
    const [results, setResults] = useState(null);
    const [step, setStep] = useState('');
    const logEndRef = useRef(null);

    const scrollToBottom = () => {
        logEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [logs]);

    const addLog = (msg) => {
        const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        setLogs(prev => [...prev, { time, msg }]);
    };

    const handleFileUpload = (e) => {
        const uploadedFile = e.target.files[0];
        if (uploadedFile) {
            setFile(uploadedFile);
            startAnalysis(uploadedFile);
        }
    };

    const startAnalysis = (uploadedFile) => {
        setIsAnalyzing(true);
        setResults(null);
        setLogs([]);
        addLog(`Artifact uploaded: ${uploadedFile.name}`);

        const steps = [
            { msg: "Calculating SHA-256 hashes...", delay: 1000 },
            { msg: "Loading artifact into secure debugger...", delay: 1500 },
            { msg: "Scanning for packed sections (UPX/Enigma)...", delay: 1200 },
            { msg: "Extracting suspicious strings and API imports...", delay: 1800 },
            { msg: "Emulating system calls in isolated memory...", delay: 2000 },
            { msg: "Performing behavioral heuristic analysis...", delay: 1500 },
            { msg: "Finalizing threat verdict and risk score...", delay: 1000 }
        ];

        let currentDelay = 0;
        steps.forEach((s, idx) => {
            currentDelay += s.delay;
            setTimeout(() => {
                addLog(s.msg);
                setStep(s.msg);
                if (idx === steps.length - 1) {
                    finalize(uploadedFile);
                }
            }, currentDelay);
        });
    };

    const finalize = (uploadedFile) => {
        const isMalicious = Math.random() > 0.4;
        const score = isMalicious ? Math.floor(Math.random() * 30) + 70 : Math.floor(Math.random() * 20) + 5;

        setResults({
            fileName: uploadedFile.name,
            hash: "ea33c18b2fe17e752ab65555c18b...9f82c",
            verdict: isMalicious ? "MALICIOUS" : "CLEAN",
            score: score,
            entropy: isMalicious ? "7.82" : "4.31",
            strings: isMalicious ?
                ["http://c2.evil-operator.com/gate", "RegOpenKeyA", "WriteProcessMemory", "SeDebugPrivilege", "IsDebuggerPresent"] :
                ["libc.so.6", "/usr/bin/local", "Hello World", "Standard-Library-v12"],
            triggers: isMalicious ? [
                { name: "Code Injection", desc: "Detected attempt to use WriteProcessMemory on remote process.", risk: "high" },
                { name: "Persistent Backdoor", desc: "Creates registry key in HKLM\\Run to survive reboot.", risk: "high" },
                { name: "Network C2", desc: "Encoded URL found in data section pointing to known C2 TLD.", risk: "med" }
            ] : [
                { name: "Standard IO", desc: "Uses typical system libraries for output.", risk: "low" }
            ]
        });
        setIsAnalyzing(false);
        addLog("Analysis Complete. Report generated.");
    };

    return (
        <div className="max-w-7xl mx-auto space-y-8 animate-fade-in pb-20 h-[calc(100vh-120px)] flex flex-col">
            {/* Header */}
            <header className="flex justify-between items-center p-8 rounded-[2.5rem] bg-dark-800/40 border border-white/5">
                <div className="flex items-center gap-6">
                    <div className="w-16 h-16 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 flex items-center justify-center text-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.2)]">
                        <Microscope size={32} />
                    </div>
                    <div>
                        <h1 className="text-3xl font-black text-white italic uppercase tracking-tighter">THREAT <span className="text-indigo-500">SANDBOX</span></h1>
                        <p className="text-xs text-gray-500 font-mono uppercase tracking-widest mt-1">Automated Static & Behavioral Analysis</p>
                    </div>
                </div>

                <div className="flex items-center gap-4">
                    <input type="file" id="malware-upload" className="hidden" onChange={handleFileUpload} />
                    <label
                        htmlFor="malware-upload"
                        className="flex items-center gap-3 px-8 py-4 bg-indigo-500 text-white rounded-2xl font-black uppercase italic tracking-tighter text-sm hover:bg-indigo-400 transition-all shadow-lg shadow-indigo-500/20 cursor-pointer active:scale-95"
                    >
                        <Upload size={18} />
                        Upload Sample
                    </label>
                </div>
            </header>

            {/* --- LAB CONTROLS (Real World) --- */}
            <div className="bg-[#1a1b26] border border-indigo-500/30 rounded-xl p-4 flex flex-col md:flex-row items-center justify-between gap-4 shadow-lg shadow-indigo-900/10 shrink-0">
                <div className="flex items-center gap-4">
                    <div className="p-3 bg-indigo-500/20 rounded-lg text-indigo-400">
                        {labStatus === 'running' ? <Activity className="animate-pulse" size={24} /> : <Shield size={24} />}
                    </div>
                    <div>
                        <h3 className="text-white font-bold flex items-center gap-2">
                            Isolated Detonation Chamber
                            {labStatus === 'running' && <span className="text-[10px] bg-red-500 text-white px-2 py-0.5 rounded font-black animate-pulse">LIVE DANGER</span>}
                        </h3>
                        <p className="text-gray-400 text-xs">Provision a secure REMnux environment for dynamic analysis.</p>
                    </div>
                </div>

                <div className="flex items-center gap-3">
                    {labStatus === 'running' && connectionInfo && (
                        <div className="flex items-center gap-3 mr-4 animate-fadeIn">
                            <div className="text-right">
                                <div className="text-[10px] text-gray-500 font-mono uppercase">VNC Connection</div>
                                <div className="text-indigo-400 font-mono font-bold">{connectionInfo.ip_address}:{connectionInfo.port}</div>
                            </div>
                            <button
                                onClick={() => window.open(`http://${connectionInfo.ip_address}:${connectionInfo.port}`, '_blank')}
                                className="p-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors"
                                title="Open VNC Web Client"
                            >
                                <ExternalLink size={18} />
                            </button>
                        </div>
                    )}

                    {labStatus === 'idle' || labStatus === 'error' ? (
                        <button
                            onClick={() => startLab()}
                            disabled={isLoading}
                            className={`flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold transition-all ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
                        >
                            <Play size={18} /> {isLoading ? 'Isolating...' : 'Spawn Chamber'}
                        </button>
                    ) : (
                        <button
                            onClick={stopLab}
                            disabled={isLoading}
                            className="flex items-center gap-2 px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold transition-all"
                        >
                            <Square size={18} fill="currentColor" /> {isLoading ? 'Destroying...' : 'Nuke Chamber'}
                        </button>
                    )}
                </div>
            </div>
            {/* -------------------------------- */}

            <div className="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-8 overflow-hidden">
                {/* Pipeline Logs */}
                <aside className="lg:col-span-1 rounded-[2.5rem] bg-dark-800/40 border border-white/5 flex flex-col overflow-hidden">
                    <div className="p-6 border-b border-white/5 flex items-center justify-between">
                        <h3 className="text-xs font-black text-gray-500 uppercase tracking-widest flex items-center gap-2">
                            <Terminal size={14} /> Analysis Pipeline
                        </h3>
                        {isAnalyzing && <Activity size={14} className="text-indigo-500 animate-pulse" />}
                    </div>
                    <div className="flex-1 p-6 space-y-3 font-mono text-[10px] overflow-y-auto bg-black/20 custom-scrollbar">
                        {logs.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-gray-700 space-y-4 opacity-50">
                                <Database size={32} />
                                <p className="uppercase tracking-widest font-black">System Idle</p>
                            </div>
                        ) : (
                            logs.map((log, i) => (
                                <motion.div
                                    key={i}
                                    initial={{ opacity: 0, x: -10 }}
                                    animate={{ opacity: 1, x: 0 }}
                                    className="flex gap-3 leading-relaxed"
                                >
                                    <span className="text-indigo-500 shrink-0">[{log.time}]</span>
                                    <span className="text-gray-400">{log.msg}</span>
                                </motion.div>
                            ))
                        )}
                        <div ref={logEndRef} />
                    </div>
                </aside>

                {/* Main Analysis View */}
                <main className="lg:col-span-2 rounded-[2.5rem] bg-dark-800/40 border border-white/5 overflow-y-auto p-10 relative custom-scrollbar">
                    <AnimatePresence mode="wait">
                        {!file && !isAnalyzing && (
                            <motion.div
                                key="empty"
                                initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                                className="h-full flex flex-col items-center justify-center text-center space-y-8 grayscale opacity-20"
                            >
                                <Skull size={120} className="text-gray-500" />
                                <div className="space-y-2">
                                    <h2 className="text-2xl font-black text-white uppercase italic tracking-tighter">Waiting for Artifact</h2>
                                    <p className="text-sm text-gray-400 max-w-xs mx-auto uppercase tracking-widest leading-loose">Upload a suspect .exe, .bin, or .dll file for deep heuristic inspection</p>
                                </div>
                            </motion.div>
                        )}

                        {isAnalyzing && (
                            <motion.div
                                key="analyzing"
                                initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                                className="h-full flex flex-col items-center justify-center text-center space-y-12"
                            >
                                <div className="relative">
                                    <div className="w-40 h-40 rounded-full border-4 border-white/5 flex items-center justify-center">
                                        <div className="w-32 h-32 rounded-full border-4 border-indigo-500 border-t-transparent animate-spin" />
                                    </div>
                                    <Activity size={48} className="absolute inset-0 m-auto text-indigo-500 animate-pulse" />
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-xl font-black text-white uppercase italic tracking-tighter animate-pulse">Scanning: {file?.name}</h3>
                                    <p className="text-xs text-indigo-500 font-mono uppercase tracking-[0.3em] h-4">{step}</p>
                                </div>
                            </motion.div>
                        )}

                        {results && !isAnalyzing && (
                            <motion.div
                                key="results"
                                initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }}
                                className="space-y-10"
                            >
                                {/* Verdict Card */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    <div className="md:col-span-2 p-8 rounded-[2.5rem] bg-white/5 border border-white/5 flex items-center justify-between group">
                                        <div>
                                            <div className="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-2">Subject Artifact</div>
                                            <h2 className="text-2xl font-black text-white uppercase italic truncate max-w-xs">{results.fileName}</h2>
                                            <div className="text-[10px] text-indigo-500 font-mono mt-2 opacity-50">{results.hash}</div>
                                        </div>
                                        <div className={`px-6 py-2 rounded-xl text-sm font-black uppercase italic tracking-tighter ${results.verdict === 'MALICIOUS' ? 'bg-red-500 text-white shadow-[0_0_30px_rgba(239,68,68,0.3)]' : 'bg-green-500 text-white shadow-[0_0_30px_rgba(34,197,94,0.3)]'}`}>
                                            {results.verdict}
                                        </div>
                                    </div>
                                    <div className="p-8 rounded-[2.5rem] bg-dark-900/40 border border-white/5 text-center flex flex-col items-center justify-center">
                                        <div className="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Threat Score</div>
                                        <div className={`text-5xl font-black italic italic tracking-tighter ${results.score > 70 ? 'text-red-500' : 'text-green-500'}`}>
                                            {results.score}<span className="text-xs">/100</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Details Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <section className="space-y-6">
                                        <h3 className="text-xs font-black text-white uppercase tracking-widest flex items-center gap-2">
                                            <FileCode size={16} className="text-indigo-500" /> Static Analysis
                                        </h3>
                                        <div className="space-y-4">
                                            <div className="p-6 rounded-3xl bg-white/5 border border-white/5 flex justify-between items-center">
                                                <span className="text-xs font-black text-gray-500 uppercase italic">File Entropy</span>
                                                <span className="text-xs font-mono text-white">{results.entropy}</span>
                                            </div>
                                            <div className="p-6 rounded-3xl bg-white/5 border border-white/5 space-y-4">
                                                <span className="text-xs font-black text-gray-500 uppercase italic block">Suspicious Strings</span>
                                                <div className="flex flex-wrap gap-2">
                                                    {results.strings.map(s => (
                                                        <code key={s} className="text-[9px] px-2 py-1 bg-black/40 rounded text-green-500 font-mono border border-white/5 transition-colors hover:border-green-500/30">{s}</code>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section className="space-y-6">
                                        <h3 className="text-xs font-black text-white uppercase tracking-widest flex items-center gap-2">
                                            <Zap size={16} className="text-yellow-500" /> Behavioral Triggers
                                        </h3>
                                        <div className="space-y-3">
                                            {results.triggers.map((t, idx) => (
                                                <div key={idx} className={`p-5 rounded-3xl border flex gap-4 ${t.risk === 'high' ? 'bg-red-500/10 border-red-500/20 text-red-500' : t.risk === 'med' ? 'bg-yellow-500/10 border-yellow-500/20 text-yellow-500' : 'bg-green-500/10 border-green-500/20 text-green-500'}`}>
                                                    <AlertTriangle size={20} className="shrink-0" />
                                                    <div className="space-y-1">
                                                        <div className="text-[11px] font-black uppercase tracking-tight leading-none">{t.name}</div>
                                                        <p className="text-[10px] text-white/50 leading-relaxed font-medium">{t.desc}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </section>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </main>
            </div>
        </div>
    );
};

export default MalwareSandbox;
