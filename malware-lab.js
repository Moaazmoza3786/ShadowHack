/* ==================== MALWARE ANALYSIS LAB v1.0 ðŸ¦ ðŸ”¬ ==================== */
/* High-Fidelity Reverse Engineering Simulator (Mock x64dbg/Ghidra) */

class AIReverseEngineer {
    constructor() {
        this.persona = {
            name: "The Reverse Engineer",
            role: "Seniot Analyst",
            tone: "Cryptic but precise"
        };
    }

    async analyzeOpcode(instruction, context) {
        // Simulating AI Analysis of Assembly
        return new Promise(resolve => {
            setTimeout(() => {
                let analysis = "";
                const inst = instruction.toLowerCase();

                if (inst.includes("mov")) analysis = "Moves data from source to destination. Check if sensitive data is being copied to a register.";
                else if (inst.includes("xor")) analysis = "XOR is often used for simple encryption or clearing a register (XOR EAX, EAX).";
                else if (inst.includes("call")) analysis = "Subroutine call. If it calls a dynamic API (like via a register), this is a key behavior to investigate.";
                else if (inst.includes("jmp") || inst.includes("jz") || inst.includes("jnz")) analysis = "Control flow instruction. This determines the execution path based on flags.";
                else if (inst.includes("push") || inst.includes("pop")) analysis = "Stack manipulation. Arguments are often pushed before a CALL.";
                else analysis = "Standard x86 instruction. Check the Intel manuals.";

                resolve({
                    message: analysis,
                    confidence: 95
                });
            }, 800);
        });
    }

    async getHint(task) {
        // Context-aware hints for the specific task
        return new Promise(resolve => {
            setTimeout(() => {
                resolve(task.validation.hint || "Analyze the control flow.");
            }, 1000);
        });
    }
}

window.MalwareLab = {
    // === STATE ===
    currentSample: null,
    currentTask: null,
    registers: { EAX: '00000000', EBX: '00000000', ECX: '00000000', EDX: '00000000', ESI: '00000000', EDI: '00000000', ESP: '0012FFC4', EBP: '0012FFF0', EIP: '00401000' },
    flags: { ZF: 0, CF: 0, OF: 0, SF: 0 },
    memory: [], // Hex dump data
    assembly: [], // Disassembly lines
    ai: new AIReverseEngineer(),

    // === SAMPLES DATA ===
    samples: {
        "ursnif_dropper": {
            name: "invoice_2024.pdf.exe",
            type: "PE32 Executable",
            sha256: "a1b2c3d4...",
            entryPoint: "0x00401000",
            assembly: [
                { offset: "00401000", bytes: "55", mnemonic: "PUSH EBP", comment: "Standard Prologue" },
                { offset: "00401001", bytes: "8BEC", mnemonic: "MOV EBP, ESP", comment: "" },
                { offset: "00401003", bytes: "6A 00", mnemonic: "PUSH 0", comment: "" },
                { offset: "00401005", bytes: "68 00304000", mnemonic: "PUSH 00403000", comment: "String 'KERNEL32.DLL'" },
                { offset: "0040100A", bytes: "FF15 00204000", mnemonic: "CALL DWORD PTR [00402000]", comment: "LoadLibraryA (Key Indicator)" },
                { offset: "00401010", bytes: "83F8 00", mnemonic: "CMP EAX, 0", comment: "Check if handle is null" },
                { offset: "00401013", bytes: "74 15", mnemonic: "JE 0040102A", comment: "Jump if failed" },
                { offset: "00401015", bytes: "68 10304000", mnemonic: "PUSH 00403010", comment: "String 'URLDownloadToFileA'" },
                { offset: "0040101A", bytes: "50", mnemonic: "PUSH EAX", comment: "hModule" },
                { offset: "0040101B", bytes: "FF15 04204000", mnemonic: "CALL DWORD PTR [00402004]", comment: "GetProcAddress" },
                { offset: "00401021", bytes: "A3 00404000", mnemonic: "MOV [00404000], EAX", comment: "Save function pointer" },
                { offset: "00401026", bytes: "FFD0", mnemonic: "CALL EAX", comment: "Execute downloaded code" },
                { offset: "00401028", bytes: "EB FE", mnemonic: "JMP 00401028", comment: "Infinite loop (Anti-Analysis?)" },
                { offset: "0040102A", bytes: "C9", mnemonic: "LEAVE", comment: "" },
                { offset: "0040102B", bytes: "C3", mnemonic: "RET", comment: "" }
            ],
            hex: "4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00 B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00"
        }
    },

    // === MAIN ===
    init(taskId, sampleId = "ursnif_dropper") {
        this.currentSample = this.samples[sampleId];
        this.currentTask = taskId;
        this.assembly = this.currentSample.assembly;
        this.render();
    },

    render() {
        const container = document.getElementById('content');
        container.innerHTML = `
            <style>
                /* MALWARE LAB STYLES */
                .mal-lab-container { 
                    display: grid; 
                    grid-template-columns: 250px 1fr 300px; 
                    grid-template-rows: 60px 1fr 200px;
                    gap: 10px;
                    height: 100vh;
                    background: #1e1e1e;
                    color: #d4d4d4;
                    font-family: 'Consolas', 'Monaco', monospace;
                    padding: 10px;
                    overflow: hidden;
                }
                .mal-header {
                    grid-column: 1 / -1;
                    background: #2d2d2d;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 0 20px;
                    border-bottom: 2px solid #007acc;
                }
                .mal-panel {
                    background: #252526;
                    border: 1px solid #3c3c3c;
                    overflow: auto;
                }
                .mal-panel-title {
                    background: #333333;
                    padding: 5px 10px;
                    font-size: 0.8rem;
                    font-weight: bold;
                    color: #ccc;
                    border-bottom: 1px solid #3c3c3c;
                    display: flex; justify-content: space-between;
                }
                
                /* DISASSEMBLY VIEW */
                .asm-row { display: flex; padding: 2px 5px; cursor: pointer; }
                .asm-row:hover { background: #2a2d2e; }
                .asm-row.selected { background: #094771 !important; color: #fff; }
                .asm-offset { color: #858585; width: 80px; }
                .asm-bytes { color: #569cd6; width: 120px; }
                .asm-mnemonic { color: #dcdcaa; flex: 1; }
                .asm-comment { color: #6a9955; margin-left: 10px; }

                /* REGISTERS */
                .reg-row { display: flex; justify-content: space-between; padding: 2px 10px; font-size: 0.9rem; }
                .reg-name { color: #569cd6; }
                .reg-val { color: #b5cea8; }
                .reg-changed { color: #f44747; }

                /* HEX VIEW */
                .hex-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; padding: 5px; font-size: 0.8rem; text-align: center;}
                .hex-byte { color: #ce9178; }

                /* CONTROLS */
                .debug-controls { display: flex; gap: 10px; }
                .debug-btn { 
                    background: #333; border: 1px solid #555; color: #fff; 
                    padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size:0.8rem; 
                }
                .debug-btn:hover { background: #444; }
                .debug-btn.play { color: #4ade80; border-color: #4ade80; }
                .debug-btn.stop { color: #ef4444; border-color: #ef4444; }

                /* AI ASSISTANT */
                .ai-assistant-panel {
                    padding: 10px;
                    font-family: 'Segoe UI', sans-serif;
                }
                .ai-msg { margin-bottom: 10px; padding: 8px; background: #333; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #007acc; }

            </style>
            
            <div class="mal-lab-container fade-in">
                <!-- HEADER -->
                <div class="mal-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-bug" style="color:#ef4444;"></i>
                        <span style="font-weight:bold;">MalwareLab Pro</span>
                        <span style="background:#333; padding:2px 8px; border-radius:4px; font-size:0.8rem;">${this.currentSample.name}</span>
                    </div>
                    <div class="debug-controls">
                        <button class="debug-btn play" onclick="alert('Simulation running...')"><i class="fas fa-play"></i> Run</button>
                        <button class="debug-btn" onclick="MalwareLab.stepOver()"><i class="fas fa-step-forward"></i> Step Over</button>
                        <button class="debug-btn" onclick="MalwareLab.stepInto()"><i class="fas fa-arrow-down"></i> Step Into</button>
                        <button class="debug-btn stop" onclick="JobSimUI.backToDashboard()"><i class="fas fa-stop"></i> Stop Debugging</button>
                    </div>
                </div>

                <!-- SIDEBAR: FUNCTIONS & IMPORTS -->
                <div class="mal-panel">
                    <div class="mal-panel-title"><span>FUNCTIONS</span></div>
                    <div style="padding:5px;">
                        <div style="color:#dcdcaa; cursor:pointer;">sub_401000 (EntryPoint)</div>
                        <div style="color:#dcdcaa; cursor:pointer;">sub_40102B</div>
                    </div>
                    <div class="mal-panel-title" style="margin-top:10px;"><span>IMPORTS</span></div>
                    <div style="padding:5px; font-size:0.85rem;">
                        <div style="color:#4ec9b0;">KERNEL32.LoadLibraryA</div>
                        <div style="color:#4ec9b0;">KERNEL32.GetProcAddress</div>
                        <div style="color:#4ec9b0;">URLMON.URLDownloadToFileA</div>
                    </div>
                </div>

                <!-- MAIN: DISASSEMBLY -->
                <div class="mal-panel">
                    <div class="mal-panel-title"><span>DISASSEMBLY - CPU</span> <span>EIP: ${this.registers.EIP}</span></div>
                    <div id="asm-view">
                        ${this.renderAssembly()}
                    </div>
                </div>

                <!-- RIGHT: REGISTERS & STACK -->
                <div class="mal-panel">
                    <div class="mal-panel-title"><span>REGISTERS</span></div>
                    <div style="padding:5px;">
                        ${Object.entries(this.registers).map(([k, v]) => `
                            <div class="reg-row">
                                <span class="reg-name">${k}</span>
                                <span class="reg-val">${v}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mal-panel-title" style="margin-top:10px;"><span>FLAGS</span></div>
                    <div style="padding:5px; display:flex; gap:10px; justify-content:center;">
                        ${Object.entries(this.flags).map(([k, v]) => `<span style="color:${v ? '#fff' : '#555'}">${k}</span>`).join('')}
                    </div>
                </div>

                <!-- BOTTOM: HEX DUMP -->
                <div class="mal-panel" style="grid-column: 1 / span 2;">
                    <div class="mal-panel-title"><span>HEX DUMP</span></div>
                    <div class="hex-grid">
                        ${this.currentSample.hex.split(' ').map(b => `<span class="hex-byte">${b}</span>`).join('')}
                    </div>
                </div>

                <!-- BOTTOM RIGHT: AI & LOGS -->
                <div class="mal-panel ai-assistant-panel">
                    <div class="mal-panel-title"><span>AI REVERSE ENGINEER</span></div>
                    <div id="ai-log">
                        <div class="ai-msg">Ready to analyze. Select an instruction to explain it.</div>
                    </div>
                    <div style="margin-top:10px; display:flex;">
                        <input type="text" id="mal-input" placeholder="Enter extracted IOC..." style="width:100%; background:#333; border:1px solid #555; color:#fff; padding:5px;">
                        <button onclick="MalwareLab.submitIOC()" style="background:#007acc; border:none; color:#fff; padding:5px 10px; cursor:pointer;">Submit</button>
                    </div>
                </div>
            </div>
        `;
    },

    renderAssembly() {
        return this.assembly.map(line => `
            <div class="asm-row ${line.offset === this.registers.EIP ? 'selected' : ''}" onclick="MalwareLab.selectInstruction('${line.offset}')">
                <span class="asm-offset">${line.offset}</span>
                <span class="asm-bytes">${line.bytes}</span>
                <span class="asm-mnemonic">${line.mnemonic}</span>
                <span class="asm-comment">; ${line.comment}</span>
            </div>
        `).join('');
    },

    async selectInstruction(offset) {
        // AI Explains the instruction
        const line = this.assembly.find(l => l.offset === offset);
        if (!line) return;

        // Highlight visual
        this.registers.EIP = offset; // Just for visual simulated stepping
        this.render(); // Re-render to update selection

        // AI Analysis
        const log = document.getElementById('ai-log');
        log.innerHTML += `<div style="color:#007acc; font-size:0.8rem; margin:5px 0;">Analyzing ${line.mnemonic}...</div>`;

        const result = await this.ai.analyzeOpcode(line.mnemonic);
        log.innerHTML += `<div class="ai-msg"><strong>AI:</strong> ${result.message}</div>`;
        log.scrollTop = log.scrollHeight;
    },

    submitIOC() {
        const val = document.getElementById('mal-input').value;
        // Simple validation for demo
        if (val.toLowerCase().includes('loadlibrary') || val.toLowerCase().includes('urlmon')) {
            alert('Correct IOC Found! XP Awarded.');
        } else {
            alert('Incorrect. Keep digging.');
        }
    },

    stepOver() {
        // Mock stepping logic
        const idx = this.assembly.findIndex(l => l.offset === this.registers.EIP);
        if (idx !== -1 && idx < this.assembly.length - 1) {
            this.registers.EIP = this.assembly[idx + 1].offset;
            this.render();
        }
    },

    stepInto() {
        this.stepOver(); // Same for now in mock
    }
};

// Export for usage
window.pageMalwareLab = () => MalwareLab.init();
